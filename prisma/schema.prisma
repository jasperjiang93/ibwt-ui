generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  walletAddress   String    @unique
  role            String    @default("user") // user, agent, admin
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // App relations
  tasks           Task[]
  agents          Agent[]
}

// ============ IBWT App Tables ============

model MCP {
  id              String   @id @default(cuid())
  name            String
  description     String?
  providerAddress String   // Solana wallet
  endpoint        String
  authType        String   @default("api_key")
  pricePerCall    Int      // In IBWT lamports
  schema          Json?
  status          String   @default("active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Agent {
  id             String   @id @default(cuid())
  name           String
  description    String?
  ownerId        String
  owner          User     @relation(fields: [ownerId], references: [id])
  walletAddress  String   // Solana wallet for payments
  webhookUrl     String
  webhookSecret  String
  capabilities   String[] // Array of capability tags
  supportedMcps  String[] // Array of MCP IDs
  status         String   @default("available")
  rating         Float    @default(0)
  completedTasks Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bids           Bid[]
  results        Result[]
}

model Task {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  userAddress    String    // Solana wallet
  request        String
  requirements   Json?
  attachments    Json?
  budgetIbwt     Int       // Max budget in lamports
  deadline       DateTime?
  status         String    @default("open")
  acceptedBidId  String?   @unique
  acceptedBid    Bid?      @relation("AcceptedBid", fields: [acceptedBidId], references: [id])
  escrowTxId     String?   // Solana transaction ID
  reviewDeadline DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  bids           Bid[]     @relation("TaskBids")
  result         Result?
}

model Bid {
  id           String   @id @default(cuid())
  taskId       String
  task         Task     @relation("TaskBids", fields: [taskId], references: [id])
  agentId      String
  agent        Agent    @relation(fields: [agentId], references: [id])
  agentAddress String
  agentFee     Int      // Agent's service fee
  mcpPlan      Json?    // [{mcp_id, mcp_name, calls, price_per_call, subtotal}]
  total        Int      // Total = agentFee + sum(mcp subtotals)
  etaMinutes   Int?
  message      String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())

  acceptedForTask Task? @relation("AcceptedBid")
}

model Result {
  id            String   @id @default(cuid())
  taskId        String   @unique
  task          Task     @relation(fields: [taskId], references: [id])
  agentId       String
  agent         Agent    @relation(fields: [agentId], references: [id])
  outputs       Json     // [{type, label, content?, url?, filename?, size?, duration?}]
  mcpCallsLog   Json?    // [{mcp_id, mcp_name, called_at, success, duration_ms}]
  revisionCount Int      @default(0)
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AccessKey {
  id        String   @id @default(cuid())
  taskId    String   @unique
  agentId   String
  key       String   @unique // Random access key
  quotas    Json     // [{mcp_id, mcp_name, allowed, used, subtotal}]
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model UploadedFile {
  id        String   @id @default(cuid())
  taskId    String
  agentId   String
  filename  String
  url       String
  size      Int
  mimeType  String
  createdAt DateTime @default(now())
}

model TaskMessage {
  id          String   @id @default(cuid())
  taskId      String
  senderType  String   // "user", "agent", "system"
  senderId    String
  senderName  String
  content     String
  messageType String   @default("text") // text, progress, file, system
  attachments Json?    // [{type, url, filename}]
  metadata    Json?    // {progress: 50}
  createdAt   DateTime @default(now())

  @@index([taskId])
}
