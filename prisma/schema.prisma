generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  walletAddress   String    @unique
  role            String    @default("user") // user, agent, admin
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // App relations
  tasks           Task[]
  agents          Agent[]
}

// ============ IBWT App Tables ============

model Mcp {
  @@map("MCP")
  id              String   @id @default(cuid())
  name            String
  description     String?
  providerAddress String   // Solana wallet
  endpoint        String
  authType        String   @default("api_key")
  pricePerCall    Int      // In IBWT lamports
  schema          Json?
  status          String   @default("active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Agent {
  id             String   @id @default(cuid())
  name           String
  description    String?
  ownerId        String
  owner          User     @relation(fields: [ownerId], references: [id])
  walletAddress  String   // Solana wallet for payments
  webhookUrl     String
  webhookSecret  String
  capabilities   String[] // Array of capability tags
  supportedMcps  String[] // Array of MCP IDs
  status         String   @default("available")
  rating         Float    @default(0)
  completedTasks Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bids           Bid[]
  results        Result[]
}

model Task {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  userAddress    String    // Solana wallet
  request        String
  requirements   Json?
  attachments    Json?
  budgetIbwt     Int       // Max budget in lamports
  deadline       DateTime?
  status         String    @default("open")
  acceptedBidId  String?   @unique
  acceptedBid    Bid?      @relation("AcceptedBid", fields: [acceptedBidId], references: [id])
  escrowTxId     String?   // Solana lock_funds transaction ID
  approveTxId    String?   // Solana approve transaction ID
  declineTxId    String?   // Solana decline transaction ID
  reviewDeadline DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  bids           Bid[]     @relation("TaskBids")
  result         Result?
}

model Bid {
  id           String   @id @default(cuid())
  taskId       String
  task         Task     @relation("TaskBids", fields: [taskId], references: [id])
  agentId      String
  agent        Agent    @relation(fields: [agentId], references: [id])
  agentAddress String
  agentFee     Int      // Agent's service fee
  mcpPlan      Json?    // [{mcp_id, mcp_name, calls, price_per_call, subtotal}]
  total        Int      // Total = agentFee + sum(mcp subtotals)
  etaMinutes   Int?
  message      String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())

  acceptedForTask Task? @relation("AcceptedBid")
}

model Result {
  id            String   @id @default(cuid())
  taskId        String   @unique
  task          Task     @relation(fields: [taskId], references: [id])
  agentId       String
  agent         Agent    @relation(fields: [agentId], references: [id])
  outputs       Json     // [{type, label, content?, url?, filename?, size?, duration?}]
  mcpCallsLog   Json?    // [{mcp_id, mcp_name, called_at, success, duration_ms}]
  revisionCount Int      @default(0)
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AccessKey {
  id        String   @id @default(cuid())
  taskId    String   @unique
  agentId   String
  key       String   @unique // Random access key
  quotas    Json     // [{mcp_id, mcp_name, allowed, used, subtotal}]
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model UploadedFile {
  id        String   @id @default(cuid())
  taskId    String
  agentId   String
  filename  String
  url       String
  size      Int
  mimeType  String
  createdAt DateTime @default(now())
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  role      String   @default("user") // user, agent_provider, mcp_provider, other
  createdAt DateTime @default(now())
}

// ============ Payment System Tables ============

model Merchant {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  name          String?
  apiKey        String    @unique @default(cuid())
  apiSecret     String    @default(cuid())
  webhookUrl    String?
  webhookSecret String?
  status        String    @default("active") // active, suspended
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  payments      Payment[]
  mcpServers    McpServer[]
}

model Payment {
  id            String    @id @default(cuid())
  merchantId    String
  merchant      Merchant  @relation(fields: [merchantId], references: [id])
  
  // Amount info
  amountUsd     Decimal   @db.Decimal(10, 4)
  amountSol     Decimal?  @db.Decimal(18, 9)
  amountUsdc    Decimal?  @db.Decimal(10, 4)
  currency      String    // SOL, USDC
  
  // Status
  status        String    @default("pending") // pending, confirmed, failed, expired
  
  // Solana Pay
  solanaPayUrl  String?
  recipientWallet String
  
  // Transaction info
  txSignature   String?
  confirmedAt   DateTime?
  
  // Metadata
  description   String?
  metadata      Json?
  
  // Expiry
  expiresAt     DateTime
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([merchantId])
  @@index([status])
  @@index([txSignature])
}

model McpServer {
  id              String    @id @default(cuid())
  merchantId      String
  merchant        Merchant  @relation(fields: [merchantId], references: [id])
  
  name            String
  description     String?
  endpointUrl     String?
  documentationUrl String?
  
  // Default pricing (can be overridden per tool)
  defaultPricingModel String @default("free") // free, per_call
  defaultPriceUsd     Decimal? @db.Decimal(10, 4)
  
  status          String    @default("active") // active, inactive, pending
  
  // Stats
  totalCalls      Int       @default(0)
  totalRevenue    Decimal   @default(0) @db.Decimal(18, 4)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tools           McpTool[]

  @@index([merchantId])
  @@index([status])
}

model McpTool {
  id              String    @id @default(cuid())
  serverId        String
  server          McpServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  inputSchema     Json?
  outputSchema    Json?
  
  // Pricing
  pricingModel    String    @default("free") // free, per_call, dynamic
  priceUsd        Decimal?  @db.Decimal(10, 4)
  dynamicConfig   Json?     // { basePrice, perTokenPrice, etc }
  
  // Stats
  totalCalls      Int       @default(0)
  totalRevenue    Decimal   @default(0) @db.Decimal(18, 4)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([serverId, name])
  @@index([serverId])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  createdAt DateTime @default(now())
}

model TaskMessage {
  id          String   @id @default(cuid())
  taskId      String
  senderType  String   // "user", "agent", "system"
  senderId    String
  senderName  String
  content     String
  messageType String   @default("text") // text, progress, file, system
  attachments Json?    // [{type, url, filename}]
  metadata    Json?    // {progress: 50}
  createdAt   DateTime @default(now())

  @@index([taskId])
}
